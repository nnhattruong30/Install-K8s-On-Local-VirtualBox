# -*- mode: ruby -*-
# vi: set ft=ruby :

# Load environment variables from .env file if dotenv gem is available
begin
  require 'dotenv'
  Dotenv.load('../.env')
rescue LoadError
  # If dotenv is not available, try to read .env file manually
  env_file = File.join(File.dirname(__FILE__), '..', '.env')
  if File.exist?(env_file)
    File.foreach(env_file) do |line|
      line.strip!
      next if line.empty? || line.start_with?('#')
      key, value = line.split('=', 2)
      ENV[key] = value if key && value
    end
  end
end

$total = (ENV['TOTAL_VMS'] || 3).to_i

Vagrant.configure(2) do |config|
  vb_group = "/Local_K8s_Cluster"

  (1..$total).each do |i|
    config.vm.define "Node-#{i}" do |node|
      node.vm.box = 'local/ubuntu-server-24'                    
      node.vm.hostname = "k8s-node-#{i}"
      node.vm.network "private_network", ip: "192.168.56.11#{i}"

      # node.vm.synced_folder './volume/', '/var/www/public/'

      node.vm.provider "virtualbox" do |vb|
        vb.name = "k8s-node-#{i}"
        vb.cpus = 2
        vb.memory = "4096"
        vb.customize ["modifyvm", :id, "--groups", vb_group]
      end
    end
  end

config.vm.provision "shell", path: "./bootstrap.sh", env: {"K8S_VERSION" => ENV['K8S_VERSION'] || "1.30"}

end